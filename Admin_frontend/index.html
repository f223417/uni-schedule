<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Timetable</title>
    <!-- PDF generation libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="date-time" id="date-time">
        <div id="current-datetime"></div>
        <div class="week-number">Week <span id="week-number"></span></div>
    </div>
    <h1>Timetable</h1>
    <div class="week-selector">
        <button id="prev-week">Previous Week</button>
        <span id="display-week"></span>
        <button id="next-week">Next Week</button>
        <button id="refresh-btn" style="margin-left: 20px; background: #4CAF50; color: white; border: none; padding: 5px 10px; cursor: pointer;">Refresh Data</button>
    </div>
    <div class="timetable-container">
        <table id="timetable-entries" class="timetable">
            <!-- Table content will be generated dynamically -->
        </table>
    </div>
    <h2>Announcements</h2>
    <div id="announcement-entries"></div>
    <h2>Notices</h2>
    <div id="notice-entries"></div>
    <div class="admin-controls">
       
    </div>
    <footer>
        <img src="logo.png" width = 250px alt="University Logo">
        <p>University</p>
        <p>For more info contact: info@university.edu.pk</p>
    </footer>
    <script>
        // Define time slots
        const timeSlots = JSON.parse(localStorage.getItem('timeSlots')) || [
            "8:00 AM", "9:00 AM", "10:00 AM", "11:00 AM", "12:00 PM", 
            "1:00 PM", "2:00 PM", "3:00 PM", "4:00 PM", "5:00 PM"
        ];
        
        // Define weekdays
        const weekdays = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
        
        // Track the currently viewed week and current week separately
        let viewingWeek = 1;
        let currentWeek = 1;
        
        // Flag to track if user has manually navigated
        let weekNavigated = false;
        
        // Flag to track if data is loading
        let isDataLoading = false;

        function updateDateTime() {
            const now = new Date();
            const formattedDateTime = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
            document.getElementById('current-datetime').textContent = formattedDateTime;
            
            // Calculate week number since the start date
            let startDate = localStorage.getItem('startDate');
            if (!startDate) {
                // If no start date is set, use the current date as the start date
                startDate = now.toISOString();
                localStorage.setItem('startDate', startDate);
            }
            
            const start = new Date(startDate);
            const diffTime = Math.abs(now - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const weekNumber = Math.ceil(diffDays / 7);
            
            // Update the current week display but don't change the viewing week
            document.getElementById('week-number').textContent = weekNumber;
            currentWeek = weekNumber;
            
            // Only set viewing week to current week when the page first loads
            if (!window.weekNavigated) {
                viewingWeek = currentWeek;
                document.getElementById('display-week').textContent = `Week ${viewingWeek}`;
            }
            
            // Update every second
            setTimeout(updateDateTime, 1000);
        }

        function formatTimeToAMPM(timeStr) {
            if (!timeStr) return '';
            
            // Check if time is already in AM/PM format
            if (timeStr.includes('AM') || timeStr.includes('PM')) {
                return timeStr;
            }
            
            try {
                // Parse 24-hour format like "14:30"
                const [hours, minutes] = timeStr.split(':').map(num => parseInt(num, 10));
                
                if (isNaN(hours) || isNaN(minutes)) {
                    return timeStr; // Return original if parsing fails
                }
                
                const period = hours >= 12 ? 'PM' : 'AM';
                const displayHours = hours % 12 || 12; // Convert 0 to 12 for 12 AM
                
                return `${displayHours}:${minutes.toString().padStart(2, '0')} ${period}`;
            } catch (e) {
                console.error('Error formatting time:', e);
                return timeStr; // Return original on error
            }
        }

        // SIMPLIFIED timetable update function - replace the existing one
        function updateTimetable() {
            console.log('Updating timetable - SHOWING ALL ENTRIES');
            const timetableEntries = JSON.parse(localStorage.getItem('timetableEntries')) || [];
            console.log('Total entries loaded:', timetableEntries.length);
            
            // Get all weeks to show EVERYTHING
            const allWeeks = [...new Set(timetableEntries.map(e => e.week))];
            console.log('All available weeks:', allWeeks);
            
            // Get the table element
            const table = document.getElementById('timetable-entries');
            if (!table) {
                console.error('Timetable element not found!');
                return;
            }
            table.innerHTML = ''; // Clear existing entries
            
            // Add a header to show which week we're displaying
            const weekHeader = document.createElement('h2');
            weekHeader.textContent = `Current View: Week ${viewingWeek}`;
            weekHeader.style.textAlign = 'center';
            weekHeader.style.marginBottom = '20px';
            table.parentNode.insertBefore(weekHeader, table);

            // IMPORTANT - SHOW ALL ENTRIES WITHOUT FILTERING
            // const currentWeekEntries = timetableEntries.filter(entry => ...); 
            // Use all entries instead of filtering:
            const currentWeekEntries = timetableEntries;
            
            console.log(`SHOWING ALL ${currentWeekEntries.length} ENTRIES IN TABLE`);
            
            // Rest of the function stays the same...
            // [...]
        }

        function updateAnnouncements() {
            const announcements = JSON.parse(localStorage.getItem('announcements')) || [];
            const announcementContainer = document.getElementById('announcement-entries');
            announcementContainer.innerHTML = ''; // Clear existing entries
            
            if (announcements.length === 0) {
                announcementContainer.innerHTML = '<p>No active announcements</p>';
                return;
            }
            
            announcements.forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'announcement';
                
                entryDiv.innerHTML = `
                    <p class="announcement-text">${entry.announcement}</p>
                    <p class="announcement-date">Posted: ${new Date(entry.date).toLocaleDateString()}</p>
                    <hr>
                `;
                announcementContainer.appendChild(entryDiv);
            });
        }

        function updateNotices() {
            const notices = JSON.parse(localStorage.getItem('notices')) || [];
            const noticeContainer = document.getElementById('notice-entries');
            noticeContainer.innerHTML = ''; // Clear existing entries
            
            notices.forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.innerHTML = `
                    <p>Notice: ${entry.notice}</p>
                    <p>Date: ${new Date(entry.date).toLocaleDateString()}</p>
                    <hr>
                `;
                noticeContainer.appendChild(entryDiv);
            });
        }

        // IMPROVED: Function to load data from API with safety checks
        function loadDataFromAPI() {
            if (isDataLoading) {
                console.log('Data load already in progress, skipping');
                return;
            }
            
            isDataLoading = true;
            console.log('Loading data from API...');
            
            // Show loading indicator
            const refreshBtn = document.getElementById('refresh-btn');
            if (refreshBtn) refreshBtn.textContent = 'Loading...';
            
            // Load timetable data
            fetch('/api/timetable')
                .then(response => {
                    if (!response.ok) throw new Error(`Server returned ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log(`Loaded ${data.length} timetable entries from API`);
                    
                    // Show week formats in the data for debugging
                    if (data.length > 0) {
                        const weekFormats = [...new Set(data.map(e => e.week))];
                        console.log('Week formats in data:', weekFormats);
                    }
                    
                    localStorage.setItem('timetableEntries', JSON.stringify(data));
                    updateTimetable();
                    isDataLoading = false;
                    if (refreshBtn) refreshBtn.textContent = 'Refresh Data';
                })
                .catch(error => {
                    console.error('Error loading timetable data:', error);
                    isDataLoading = false;
                    if (refreshBtn) refreshBtn.textContent = 'Refresh Data';
                });
            
            // Load announcements
            fetch('/api/announcements')
                .then(response => response.json())
                .then(data => {
                    console.log(`Loaded ${data.length} announcements from API`);
                    localStorage.setItem('announcements', JSON.stringify(data));
                    updateAnnouncements();
                })
                .catch(error => console.error('Error loading announcements:', error));
            
            // Load notices
            fetch('/api/notices')
                .then(response => response.json())
                .then(data => {
                    console.log(`Loaded ${data.length} notices from API`);
                    localStorage.setItem('notices', JSON.stringify(data));
                    updateNotices();
                })
                .catch(error => console.error('Error loading notices:', error));
        }
        
        // Function to handle week navigation
        function navigateWeek(direction) {
            if (direction === 'next') {
                viewingWeek++;
                window.weekNavigated = true;
            } else if (direction === 'prev') {
                viewingWeek = Math.max(1, viewingWeek - 1);
                window.weekNavigated = true;
            }
            
            document.getElementById('display-week').textContent = `Week ${viewingWeek}`;
            updateTimetable();
        }
        
        // IMPROVED: Function to cycle through weeks with safety checks
        function cycleThroughWeeks() {
            // Only cycle if not manually navigated and not loading data
            if (viewingWeek === currentWeek && !window.weekNavigated && !isDataLoading) {
                console.log('Starting cycle - current week display');
                
                // After 20 seconds, show next week
                setTimeout(() => {
                    if (isDataLoading) {
                        console.log('Data loading in progress, delaying cycle');
                        cycleThroughWeeks(); // Retry
                        return;
                    }
                    
                    viewingWeek = currentWeek + 1;
                    document.getElementById('display-week').textContent = `Week ${viewingWeek}`;
                    updateTimetable();
                    console.log("Showing next week:", viewingWeek);
                    
                    // After 10 seconds showing next week, go back to current
                    setTimeout(() => {
                        if (isDataLoading) {
                            console.log('Data loading in progress, delaying cycle');
                            // Reset to current week and retry
                            viewingWeek = currentWeek;
                            document.getElementById('display-week').textContent = `Week ${viewingWeek}`;
                            updateTimetable();
                            cycleThroughWeeks();
                            return;
                        }
                        
                        viewingWeek = currentWeek;
                        document.getElementById('display-week').textContent = `Week ${viewingWeek}`;
                        updateTimetable();
                        console.log("Back to current week:", viewingWeek);
                        cycleThroughWeeks(); // Restart the cycle
                    }, 10000);
                }, 20000);
            } else {
                // If manually navigated, check again in a bit
                console.log('Skipping cycle - user navigated or data loading');
                setTimeout(cycleThroughWeeks, 5000);
            }
        }

        // Initialize everything when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM content loaded - initializing timetable display');
            
            // Initial setup
            updateDateTime();
            updateTimetable();
            
            // Setup navigation buttons
            const prevWeekBtn = document.getElementById('prev-week');
            const nextWeekBtn = document.getElementById('next-week');
            const refreshBtn = document.getElementById('refresh-btn');
            
            if (prevWeekBtn) {
                prevWeekBtn.addEventListener('click', function() {
                    navigateWeek('prev');
                });
            }
            
            if (nextWeekBtn) {
                nextWeekBtn.addEventListener('click', function() {
                    navigateWeek('next');
                });
            }
            
            if (refreshBtn) {
                refreshBtn.addEventListener('click', function() {
                    loadDataFromAPI();
                });
            }
            
            // Initial data load
            loadDataFromAPI();
            
            // Just refresh data every minute
            setInterval(loadDataFromAPI, 60000); // Every minute
        });
    </script>
    <script src="index.js"></script>
</body>
</html>