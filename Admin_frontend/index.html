<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>Timetable</title>
    <!-- PDF generation libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
    <div class="date-time" id="date-time">
        <div id="current-datetime"></div>
        <div class="week-number">Week <span id="week-number"></span></div>
    </div>
    <h1>Timetable</h1>
    <div class="week-selector">
        <button id="prev-week">Previous Week</button>
        <span id="display-week"></span>
        <button id="next-week">Next Week</button>
    </div>
    <div class="timetable-container">
        <table id="timetable-entries" class="timetable">
            <!-- Table content will be generated dynamically -->
        </table>
    </div>
    <h2>Announcements</h2>
    <div id="announcement-entries"></div>
    <h2>Notices</h2>
    <div id="notice-entries"></div>
    <div class="admin-controls">
       
    </div>
    <footer>
        <img src="logo.png" width = 250px alt="University Logo">
        <p>University</p>
        <p>For more info contact: info@university.edu.pk</p>
    </footer>
    <script>
        // Define time slots
        const timeSlots = JSON.parse(localStorage.getItem('timeSlots')) || [
            "8:00 AM", "9:00 AM", "10:00 AM", "11:00 AM", "12:00 PM", 
            "1:00 PM", "2:00 PM", "3:00 PM", "4:00 PM", "5:00 PM"
        ];
        
        // Define weekdays
        const weekdays = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
        
        // Track the currently viewed week and current week separately
        let viewingWeek = 1;
        let currentWeek = 1;

        function updateDateTime() {
            const now = new Date();
            const formattedDateTime = now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
            document.getElementById('current-datetime').textContent = formattedDateTime;
            
            // Calculate week number since the start date
            let startDate = localStorage.getItem('startDate');
            if (!startDate) {
                // If no start date is set, use the current date as the start date
                startDate = now.toISOString();
                localStorage.setItem('startDate', startDate);
            }
            
            const start = new Date(startDate);
            const diffTime = Math.abs(now - start);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            const weekNumber = Math.ceil(diffDays / 7);
            
            // Update the current week display but don't change the viewing week
            document.getElementById('week-number').textContent = weekNumber;
            currentWeek = weekNumber;
            
            // Set display week if it hasn't been set yet
            if (!document.getElementById('display-week').textContent) {
                document.getElementById('display-week').textContent = `Week ${viewingWeek}`;
            }
            
            // Update every second
            setTimeout(updateDateTime, 1000);
        }

        function formatTimeToAMPM(timeStr) {
            if (!timeStr) return '';
            
            // Check if time is already in AM/PM format
            if (timeStr.includes('AM') || timeStr.includes('PM')) {
                return timeStr;
            }
            
            try {
                // Parse 24-hour format like "14:30"
                const [hours, minutes] = timeStr.split(':').map(num => parseInt(num, 10));
                
                if (isNaN(hours) || isNaN(minutes)) {
                    return timeStr; // Return original if parsing fails
                }
                
                const period = hours >= 12 ? 'PM' : 'AM';
                const displayHours = hours % 12 || 12; // Convert 0 to 12 for 12 AM
                
                return `${displayHours}:${minutes.toString().padStart(2, '0')} ${period}`;
            } catch (e) {
                console.error('Error formatting time:', e);
                return timeStr; // Return original on error
            }
        }

        // Update the timetable function in your index.html file
        function updateTimetable() {
            console.log('Updating timetable for week', viewingWeek);
            const timetableEntries = JSON.parse(localStorage.getItem('timetableEntries')) || [];
            console.log('Total entries loaded:', timetableEntries.length); // Debug log
            
            const table = document.getElementById('timetable-entries');
            if (!table) {
                console.error('Timetable element not found!');
                return;
            }
            table.innerHTML = ''; // Clear existing entries
            
            // Filter entries for the current viewing week
            const currentWeekEntries = timetableEntries.filter(entry => {
                // Skip entries without week information
                if (!entry.week && entry.week !== 0) {
                    console.log('Entry missing week property:', entry);
                    return false;
                }
                
                // Normalize the entry week format
                const entryWeek = String(entry.week).toLowerCase().trim();
                const targetWeek = String(viewingWeek).toLowerCase().trim();
                const targetWeekFormatted = `week ${targetWeek}`.toLowerCase().trim();
                
                // Debug
                console.log(`Comparing entry week "${entryWeek}" with target "${targetWeek}" or "${targetWeekFormatted}"`);
                
                // Multiple matching approaches
                return entryWeek === targetWeek || 
                       entryWeek === targetWeekFormatted ||
                       entryWeek.includes(targetWeek) ||
                       entryWeek.replace(/\s+/g, '') === targetWeekFormatted.replace(/\s+/g, '');
            });
            
            console.log('Filtered entries for week', viewingWeek, ':', currentWeekEntries);
            // Log the actual entries for debugging
            currentWeekEntries.forEach((entry, i) => {
                console.log(`Entry ${i+1}:`, entry.course, entry.days, `${entry.startTime}-${entry.endTime}`);
            });
            
            console.log('Filtered entries for week', viewingWeek, ':', currentWeekEntries.length); // Debug log
            
            // Determine which days have entries for this week
            const activeDays = new Set();
            currentWeekEntries.forEach(entry => {
                // Handle both array and string days
                if (entry.days) {
                    if (Array.isArray(entry.days)) {
                        entry.days.forEach(day => activeDays.add(day));
                    } else if (typeof entry.days === 'string') {
                        activeDays.add(entry.days);
                    }
                } else if (entry.day) {
                    activeDays.add(entry.day);
                }
            });
            
            console.log('Active days detected:', Array.from(activeDays)); // Debug log
            
            // Always show Monday-Friday
            const defaultWeekdays = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];
            const daysToDisplay = [...defaultWeekdays];
            
            // Add weekend days if they have entries
            if (activeDays.has("Saturday")) daysToDisplay.push("Saturday");
            if (activeDays.has("Sunday")) daysToDisplay.push("Sunday");
            
            // Create header row
            const headerRow = document.createElement('tr');
            
            // Time column header
            const timeHeader = document.createElement('th');
            timeHeader.textContent = "Time";
            headerRow.appendChild(timeHeader);
            
            // Add day headers
            daysToDisplay.forEach(day => {
                const th = document.createElement('th');
                th.textContent = day;
                headerRow.appendChild(th);
            });
            
            table.appendChild(headerRow);
            
            // Get unique time slots from entries
            const customTimeSlots = [];
            currentWeekEntries.forEach(entry => {
                // Skip entries without time information
                if (!entry.startTime || !entry.endTime) return;
                
                // Add time slot if not already in the list
                if (!customTimeSlots.some(slot => slot.start === entry.startTime && slot.end === entry.endTime)) {
                    customTimeSlots.push({
                        start: entry.startTime,
                        end: entry.endTime,
                        display: entry.displayTime || `${formatTimeToAMPM(entry.startTime)} - ${formatTimeToAMPM(entry.endTime)}`
                    });
                }
            });
            
            console.log('Custom time slots:', customTimeSlots.length); // Debug log
            
            // Sort time slots by start time
            if (customTimeSlots.length > 0) {
                customTimeSlots.sort((a, b) => {
                    // Simple string comparison for time
                    return a.start.localeCompare(b.start);
                });
                
                // Create rows for each time slot
                customTimeSlots.forEach(timeSlot => createTimeSlotRow(timeSlot, daysToDisplay, currentWeekEntries));
            } else {
                // If no entries have time slots, show default empty timetable
                const timeSlotList = timeSlots || [
                    "8:00 AM", "9:00 AM", "10:00 AM", "11:00 AM", "12:00 PM", 
                    "1:00 PM", "2:00 PM", "3:00 PM", "4:00 PM", "5:00 PM"
                ];
                
                timeSlotList.forEach(time => {
                    const row = document.createElement('tr');
                    
                    // Time cell
                    const timeCell = document.createElement('td');
                    timeCell.textContent = time;
                    timeCell.className = 'time-cell';
                    row.appendChild(timeCell);
                    
                    // Add empty cells for each day
                    daysToDisplay.forEach(() => {
                        const cell = document.createElement('td');
                        row.appendChild(cell);
                    });
                    
                    table.appendChild(row);
                });
            }
            
            // Helper function to create a row for a time slot
            function createTimeSlotRow(timeSlot, days, entries) {
                const row = document.createElement('tr');
                
                // Add time slot in the first cell
                const timeCell = document.createElement('td');
                timeCell.textContent = timeSlot.display;
                timeCell.className = 'time-cell';
                row.appendChild(timeCell);
                
                // Add cells for each day
                days.forEach(day => {
                    const cell = document.createElement('td');
                    
                    // Find entries for this day and time slot
                    const dayEntries = entries.filter(entry => {
                        // Check if entry has days and they include this day
                        let dayMatch = false;
                        if (Array.isArray(entry.days)) {
                            dayMatch = entry.days.includes(day);
                        } else if (typeof entry.days === 'string') {
                            dayMatch = entry.days === day;
                        } else if (entry.day) {
                            dayMatch = entry.day === day;
                        }
                        
                        // Check if time slot matches
                        const timeMatch = entry.startTime === timeSlot.start && entry.endTime === timeSlot.end;
                        
                        return dayMatch && timeMatch;
                    });
                    
                    console.log(`Found ${dayEntries.length} entries for ${day} at ${timeSlot.display}`); // Debug
                    
                    // Add content to cell if there are entries
                    dayEntries.forEach(entry => {
                        const entryDiv = document.createElement('div');
                        entryDiv.className = 'class-entry';
                        
                        // Use more robust content generation
                        let entryContent = `<strong>${entry.course || 'Class'}</strong>`;
                        
                        if (entry.venue) {
                            entryContent += `<p class="venue">${entry.venue}</p>`;
                        }
                        
                        if (entry.teacher) {
                            entryContent += `<p class="teacher">${entry.teacher}</p>`;
                        }
                        
                        entryDiv.innerHTML = entryContent;
                        cell.appendChild(entryDiv);
                    });
                    
                    row.appendChild(cell);
                });
                
                table.appendChild(row);
            }
        }

        function updateAnnouncements() {
            const announcements = JSON.parse(localStorage.getItem('announcements')) || [];
            const announcementContainer = document.getElementById('announcement-entries');
            announcementContainer.innerHTML = ''; // Clear existing entries
            
            // Get current date for comparing
            const now = new Date();
            
            // Filter out expired announcements
            const activeAnnouncements = announcements.filter(entry => {
                const expiryDate = new Date(entry.expiryDate);
                return expiryDate >= now;
            });
            
            if (activeAnnouncements.length === 0) {
                announcementContainer.innerHTML = '<p>No active announcements</p>';
                return;
            }
            
            activeAnnouncements.forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'announcement';
                
                // Calculate remaining days
                const expiryDate = new Date(entry.expiryDate);
                const diffTime = Math.abs(expiryDate - now);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                entryDiv.innerHTML = `
                    <p class="announcement-text">${entry.announcement}</p>
                    <p class="announcement-date">Posted: ${new Date(entry.date).toLocaleDateString()}</p>
                    <p class="announcement-expiry">Expires in: ${diffDays} day(s)</p>
                    <hr>
                `;
                announcementContainer.appendChild(entryDiv);
            });
        }

        function updateNotices() {
            const notices = JSON.parse(localStorage.getItem('notices')) || [];
            const noticeContainer = document.getElementById('notice-entries');
            noticeContainer.innerHTML = ''; // Clear existing entries
            
            notices.forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.innerHTML = `
                    <p>Notice: ${entry.notice}</p>
                    <p>Date: ${new Date(entry.date).toLocaleDateString()}</p>
                    <hr>
                `;
                noticeContainer.appendChild(entryDiv);
            });
        }

        function clearAllEntries() {
            if (confirm('Are you sure you want to delete all entries? This cannot be undone.')) {
                localStorage.removeItem('timetableEntries');
                localStorage.removeItem('announcements');
                localStorage.removeItem('notices');
                // Don't remove the startDate to keep the week count intact
                
                updateTimetable();
                updateAnnouncements();
                updateNotices();
                
                alert('All entries have been cleared.');
            }
        }

        // Replace your loadDataFromAPI function with this:
        function loadDataFromAPI() {
            console.log('Loading data from API for display...');
            
            // Disable buttons during load to prevent interruptions
            const prevWeekBtn = document.getElementById('prev-week');
            const nextWeekBtn = document.getElementById('next-week');
            
            if (prevWeekBtn) prevWeekBtn.disabled = true;
            if (nextWeekBtn) nextWeekBtn.disabled = true;
            
            // Keep track of completed requests
            let requestsCompleted = 0;
            const totalRequests = 3;
            
            // Function to enable buttons when all requests are complete
            function checkIfComplete() {
                requestsCompleted++;
                if (requestsCompleted >= totalRequests) {
                    if (prevWeekBtn) prevWeekBtn.disabled = false;
                    if (nextWeekBtn) nextWeekBtn.disabled = false;
                    console.log('All data loaded successfully');
                }
            }
            
            // Load timetable data
            fetch('/api/timetable')
                .then(response => {
                    if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    console.log(`Loaded ${data.length} timetable entries from API`);
                    if (Array.isArray(data) && data.length > 0) {
                        // Store in localStorage for offline access
                        localStorage.setItem('timetableEntries', JSON.stringify(data));
                        // Update the display
                        updateTimetable();
                    } else {
                        console.warn('Retrieved timetable data was empty or invalid');
                    }
                    checkIfComplete();
                })
                .catch(error => {
                    console.error('Error loading timetable data:', error);
                    checkIfComplete();
                });
            
            // Similar changes for announcements and notices fetch calls...
            // ... (keep the rest of your function as it is)
            
            fetch('/api/announcements')
                .then(response => response.json())
                .then(data => {
                    console.log(`Loaded ${data.length} announcements from API`);
                    localStorage.setItem('announcements', JSON.stringify(data));
                    updateAnnouncements();
                    checkIfComplete();
                })
                .catch(error => {
                    console.error('Error loading announcements:', error);
                    checkIfComplete();
                });
            
            fetch('/api/notices')
                .then(response => response.json())
                .then(data => {
                    console.log(`Loaded ${data.length} notices from API`);
                    localStorage.setItem('notices', JSON.stringify(data));
                    updateNotices();
                    checkIfComplete();
                })
                .catch(error => {
                    console.error('Error loading notices:', error);
                    checkIfComplete();
                });
            
            // Add this in your loadDataFromAPI function after setting the localStorage (around line 377)

            // Debug the loaded data
            fetch('/api/timetable')
                .then(response => response.json())
                .then(data => {
                    console.log('TIMETABLE DATA LOADED:', data);
                    console.log('Week formats in data:', [...new Set(data.map(e => e.week))]);
                    
                    // Force refresh with the latest data
                    localStorage.setItem('timetableEntries', JSON.stringify(data));
                    updateTimetable();
                    
                    // Check if entries would match current week
                    const viewWeek = document.getElementById('display-week').textContent.replace('Week ', '').trim();
                    const matchingEntries = data.filter(e => 
                        String(e.week).toLowerCase().includes(String(viewWeek).toLowerCase()) ||
                        String(e.week).toLowerCase() === `week ${viewWeek}`.toLowerCase()
                    );
                    console.log(`Entries matching current week ${viewWeek}:`, matchingEntries);
                })
                .catch(err => console.error('Debug fetch error:', err));
        }

        // MAIN INITIALIZATION - SINGLE DOMContentLoaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM content loaded - initializing timetable display');
            
            // Initial setup
            updateDateTime();
            updateTimetable(); // Display what's currently in localStorage
            
            // Initial data load from API
            loadDataFromAPI();
            
            // Rest of your initialization code...
            
            // REMOVE any auto-cycling
            
            // Use a single, longer interval for refreshing data
            // Reduced frequency to prevent data loading issues
            setInterval(loadDataFromAPI, 5 * 60 * 1000); // Every 5 minutes
        });
    </script>
    <script src="index.js"></script>
</body>
</html>